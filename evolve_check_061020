<?xml version="1.0" encoding="UTF-8"?>
<config xmlns="http://web-harvest.sourceforge.net/schema/1.0/config" scriptlang="groovy">

<secrets-vault-get alias="evolve_debit" />
<secrets-vault-get alias="evolve_credit" />

<var-def name="bot_task_properties">
	<datastore name="sfi_refund">
		<template>select * from @this</template>
	</datastore>
</var-def>

<script><![CDATA[
	def BOT_CONFIG = [:]
	bot_task_properties.getWrappedObject().toList().each { property ->
		BOT_CONFIG.put(property.get("name").toString(), property.get("value").toString())
	}
	sys.defineVariable("BOT_CONFIG", BOT_CONFIG)
]]></script>
	
	<robotics-flow>
<robot driver="universal" name="driver" start-in-private="false" close-on-completion="true">
			<capability name ="SEARCH_ALL_WINDOWS" value="true"/>
			<capability name="CLOSE_ALL_WINDOWS" value="false"/>
			
			<capability name="chromeOptions">
				<script return="chromeArgs"><![CDATA[
					
					//DONWLOAD PATH [put path in datastore in this format-->\\muebcyp02fvg02\eProcessing1$\ROBOTICS\SFI Refund\config\Open]
					String daily_path = daily_path_str;
					
					import org.openqa.selenium.chrome.ChromeOptions;
					String dl_path = "";
					ChromeOptions options = new ChromeOptions();
					Map<String,Object> prefs = new HashMap<String,Object>();
					prefs.put("download.default_directory",daily_path);
					options.setExperimentalOption("prefs",prefs)
					chromeArgs = options;
				 ]]></script>
			</capability>
			
			
		<script><![CDATA[
			
			//Recycle
			String daily_path =  daily_path_str;
			String dateExcelPath = daily_report_path_str;
			
			//path
			String log_path = daily_path+"log.txt";
			
			////DATASTORE
			//EVOLVE PORTAL
			String evolve_portal = (BOT_CONFIG.getWrappedObject().get("evolve_portal").toString());
			
			//SECRETS VAULT
			Map entryMap = secureEntryMap.getWrappedObject();
			Map entryMap2 = secureEntryMap.getWrappedObject();
			com.freedomoss.crowdcontrol.webharvest.web.dto.SecureEntryDTO obj = entryMap.get("evolve_debit");
			com.freedomoss.crowdcontrol.webharvest.web.dto.SecureEntryDTO obj2 = entryMap.get("evolve_crebit");
			evolve_debit_login = obj.getKey().toString();
			evolve_credit_login = obj2.getKey().toString();
			evolve_debit_pass = obj.getValue().toString();
			evolve_credit_pass = obj2.getValue().toString();
			
			//LOG FILE
			FileWriter fr = new FileWriter(log_path, true);
			BufferedWriter loginta = new BufferedWriter(fr);
			
			loginta.append("----------------------------------------------------");
			loginta.newLine();
			loginta.append("--EVOLVE--");
			loginta.newLine();
			loginta.newLine();
			
			/////////////////////////////////////////////////////////DEBIT/////////////////////////////////////////////////////////////////
			
			log.info("SFI Evolve- Debit");
			loginta.append("SFI Evolve- Debit");
			loginta.newLine();
			//openChrome('http://muubhemapp0007.corp.dsarena.com:8180/sfiwebclient/login.jsp');
			openChrome(evolve_portal);
			//Username = "OLI@01REVD" 
			Username = evolve_debit_login;
			Password = evolve_debit_pass;
			//Password = "Apple001"
		
			connectUsername = $(byXpath('//table/tbody/tr/td/input[@name = "username"]'))
			connectUsername.sendKeys(Username);
		
			connectPassword = $(byXpath('//table/tbody/tr/td/input[@name ="password"]'))
			connectPassword.sendKeys(Password);
		
			connect = $(byXpath('//table/tbody/tr/td/input[@value ="Login"]'));
			connect.click();
			sleep(2000);
			
			log.info("Login Successful with user- "+Username);
			loginta.append("Login Successful with user- ");
			loginta.append(evolve_login);
			loginta.newLine();
			
			// Switching to the 1st frame, frame index 1
			switchTo().frame(1)
			
			try{
				setFluentWaitTimeout(180000)      
				  setFluentWaitPollingInterval(300)
				fluentWait()
				.ignoring(org.openqa.selenium.NoSuchElementException.class)
				.until(ExpectedConditions.presenceOfElementLocated(By.xpath(('//table/tbody/tr/td/a[@target="content"][contains(text(),"Process Centre")]'))));
			}
			catch (Exception) {
			}
			ProcessCentre = $(byXpath('//table/tbody/tr/td/a[@target="content"][contains(text(),"Process Centre")]'));
			ProcessCentre.click();
			
			// Switching to the parent frame, frame index content
			switchTo().defaultContent();
			switchTo().frame("content")
					
			UploadFiles = $(byXpath('//*[@type="button"][@value="reset"]'));
			UploadFiles.click();
			sleep(1000);
			confirm();
			try{
				setFluentWaitTimeout(180000)      
				setFluentWaitPollingInterval(300)
				fluentWait()
				.ignoring(org.openqa.selenium.NoSuchElementException.class)
				.until(ExpectedConditions.presenceOfElementLocated(By.xpath(('//table/tbody/tr/td/input[@type="button"][@value="Upload Files"]'))));
			}
			catch (Exception) {
			}
			//choose file to upload
			UploadFiles = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Upload Files"]'));
			UploadFiles.click();
			AddToList = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Add To List"]'));
			AddToList.click();
			chooseFile = $(byXpath('//*[@id="file1"]'));
			chooseFile.click();
			sleep(3000)
			//send path to file explorer
			setClipboardText(dateExcelPath)
			log.info("Daily Excel Path: "+dateExcelPath);
			pressCtrlV();
			pressEnter();
			//click on upload
			sleep(100);
			upload = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="upload"]'));
			upload.click();
			sleep(1000);
			refresh = $(byXpath('//*[@value="Refresh"]'));////*[@id="page_border"]/table/tbody/tr/td[2]/input[1]
			refresh.click()
			try{
				setFluentWaitTimeout(180000)      
				  setFluentWaitPollingInterval(300)
				fluentWait()
				.ignoring(org.openqa.selenium.NoSuchElementException.class)
				.until(ExpectedConditions.presenceOfElementLocated(By.xpath(('//table/tbody/tr/td/input[@type="button"][@value="Refresh"]'))));
			}
			catch (Exception) {

			}
			
			//refresh and submit
			try {
				refresh = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Refresh"]'));
				refresh.click();
				sleep(1000);
				submit = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Submit Files"]'));
				submit.click();
				log.info("Debit File Submitted");
				loginta.append("Debit File Submitted");
				loginta.newLine();
				
				}
			catch (Exception e){
				try {
					//need to click on allow if the file have same amount as another file will do it later
					allow =  $(byXpath('//*[contains(text(),"Allow")]'));
					allow.click();

					refresh = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Refresh"]'));
					refresh.click();
					sleep(1000);

					submit = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Submit Files"]'));
					submit.click();

				// if fail need to call mail to send error
				} catch (Exception ee) {
					xpathError=$(byXpath('//div[@id="divView"]/table/tbody/tr[2]/td[2]/table/tbody/tr[2]/td[5]')); //error details and also debit total
					xpathErrortext = xpathError.getText();
					log.info("Error while uploading: "+xpathErrortext);
					loginta.append("Error while uploading: ");
					loginta.append(xpathErrortext);
					loginta.newLine();

				}

			}
			
			sleep(2000);
			refresh = $(byXpath('//*[@value="Refresh"]'));////*[@id="page_border"]/table/tbody/tr/td[2]/input[1]
			refresh.click()
			sleep(2000);
			countXpath = 2
			
			//download report and advice files
			while (true){
				try {
					//need to click on allow if the file have same amount as another file
					adv = $(byXpath('//*[@id="divView"]/table[2]/tbody/tr[2]/td[2]/table/tbody/tr['+countXpath+']/td[1]/a'));
					adv.click();
					sleep(1000);
					countXpath = countXpath + 1;
				}
				catch (exception) {
					break;
				}//end catch
			} //end while
			log.info("Advice and Report Files downloaded");
			loginta.append("Advice and Report Files downloaded");
			loginta.newLine();
			
			//reset rows
			reset = $(byXpath('//*[@id="page_border"]/table/tbody/tr/td[2]/input[1]'));
			reset.click();
			confirm();
			log.info("Rows Resetto");
			
			sleep(1000);
			switchTo().defaultContent();
			switchTo().frame(1)
			
			//logout
			logout = $(byXpath("//a[contains(text(),'Logout')]"));
			logout.click();
			sleep(3000);
			
			//relogin
			relogin = $(byXpath("//a[contains(text(),'Login')]"));
			relogin.click();

			/////////////////////////////////////////////////////////DEBIT/////////////////////////////////////////////////////////////////		
			

			////////////////////////////////////////////////////////CREDIT/////////////////////////////////////////////////////////////////
			
			log.info("SFI Evolve- Credit");
			Username = evolve_credit_login; 
			Password = evolve_credit_pass;
		
			connectUsername = $(byXpath('//table/tbody/tr/td/input[@name = "username"]'))
			connectUsername.sendKeys(Username);
		
			connectPassword = $(byXpath('//table/tbody/tr/td/input[@name ="password"]'))
			connectPassword.sendKeys(Password);
		
			connect = $(byXpath('//table/tbody/tr/td/input[@value ="Login"]'));
			connect.click();
			sleep(2000);
			
			log.info("Login Successful with user- "+Username);
			loginta.append("Login Successful with user- ");
			loginta.append(evolve_login);
			loginta.newLine();
			
			// Switching to the 1st frame, frame index 1
			switchTo().frame(1)
			
			try{
				setFluentWaitTimeout(180000)      
				  setFluentWaitPollingInterval(300)
				fluentWait()
				.ignoring(org.openqa.selenium.NoSuchElementException.class)
				.until(ExpectedConditions.presenceOfElementLocated(By.xpath(('//table/tbody/tr/td/a[@target="content"][contains(text(),"Process Centre")]'))));
			}
			catch (Exception) {
			}
			ProcessCentre = $(byXpath('//table/tbody/tr/td/a[@target="content"][contains(text(),"Process Centre")]'));
			ProcessCentre.click();
			
			// Switching to the parent frame, frame index content
			switchTo().defaultContent();
			switchTo().frame("content")
					
			UploadFiles = $(byXpath('//*[@type="button"][@value="reset"]'));
			UploadFiles.click();
			sleep(1000);
			confirm();
			try{
				setFluentWaitTimeout(180000)      
				setFluentWaitPollingInterval(300)
				fluentWait()
				.ignoring(org.openqa.selenium.NoSuchElementException.class)
				.until(ExpectedConditions.presenceOfElementLocated(By.xpath(('//table/tbody/tr/td/input[@type="button"][@value="Upload Files"]'))));
			}
			catch (Exception) {
			}
			//choose file to upload
			UploadFiles = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Upload Files"]'));
			UploadFiles.click();
			AddToList = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Add To List"]'));
			AddToList.click();
			chooseFile = $(byXpath('//*[@id="file1"]'));
			chooseFile.click();
			sleep(3000)
			//send path to file explorer
			setClipboardText(dateExcelPath)
			log.info("Daily Excel Path: "+dateExcelPath);
			pressCtrlV();
			pressEnter();
			//click on upload
			sleep(100);
			upload = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="upload"]'));
			upload.click();
			sleep(1000);
			refresh = $(byXpath('//*[@value="Refresh"]'));////*[@id="page_border"]/table/tbody/tr/td[2]/input[1]
			refresh.click()
			try{
				setFluentWaitTimeout(180000)      
				  setFluentWaitPollingInterval(300)
				fluentWait()
				.ignoring(org.openqa.selenium.NoSuchElementException.class)
				.until(ExpectedConditions.presenceOfElementLocated(By.xpath(('//table/tbody/tr/td/input[@type="button"][@value="Refresh"]'))));
			}
			catch (Exception) {

			}
			
			//refresh and submit
			try {
				refresh = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Refresh"]'));
				refresh.click();
				sleep(1000);
				submit = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Submit Files"]'));
				submit.click();
				log.info("Credit File Submitted");
				loginta.append("Credit File Submitted");
				loginta.newLine();
				}
			catch (Exception e){
				try {
					//need to click on allow if the file have same amount as another file will do it later
					allow =  $(byXpath('//*[contains(text(),"Allow")]'));
					allow.click();

					refresh = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Refresh"]'));
					refresh.click();
					sleep(1000);

					submit = $(byXpath('//table/tbody/tr/td/input[@type="button"][@value="Submit Files"]'));
					submit.click();

				// if fail need to call mail to send error
				} catch (Exception ee) {
					xpathError=$(byXpath('//div[@id="divView"]/table/tbody/tr[2]/td[2]/table/tbody/tr[2]/td[5]')); //error details and also debit total
					xpathErrortext = xpathError.getText()
					log.info("Error while uploading: "+xpathErrortext);
					loginta.append("Error while uploading: ");
					loginta.append(xpathErrortext);
					loginta.newLine();

				}

			}
			
			sleep(2000);
			refresh = $(byXpath('//*[@value="Refresh"]'));////*[@id="page_border"]/table/tbody/tr/td[2]/input[1]
			refresh.click()
			sleep(2000);
			countXpath = 2
			
			//download report and advice files
			while (true){
				try {
					//need to click on allow if the file have same amount as another file
					adv = $(byXpath('//*[@id="divView"]/table[2]/tbody/tr[2]/td[2]/table/tbody/tr['+countXpath+']/td[1]/a'));
					adv.click();
					sleep(1000);
					countXpath = countXpath + 1;
				}
				catch (exception) {
					break;
				}//end catch
			} //end while
			
			log.info("Advice and Report Files downloaded");
			loginta.append("Advice and Report Files downloaded");
			loginta.newLine();
			
			//reset rows
			reset = $(byXpath('//*[@id="page_border"]/table/tbody/tr/td[2]/input[1]'));
			reset.click();
			confirm();
			log.info("Rows Resetto");
			
			sleep(1000);
			switchTo().defaultContent();
			switchTo().frame(1)
			
			//logout
			logout = $(byXpath("//a[contains(text(),'Logout')]"));
			logout.click();
			sleep(3000);


			////////////////////////////////////////////////////////CREDIT/////////////////////////////////////////////////////////////////		
				
			
			loginta.append("----------------------------------------------------");
			loginta.newLine();
			loginta.newLine();
			loginta.close(); 
			
		]]></script>
	
	</robot>
</robotics-flow>
	
    <export include-original-data="true">
	
</export>

</config>		
